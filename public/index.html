<!-- index.html ‚úÖ FULL UPDATED (your frontend) ‚Äî no cuts
     ONLY change: adminEmailCustomer now shows REAL backend error details
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yordi Coffee - Online Shopping</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height:1.6; color:#1a1a1a; background:#fff; }

    .header{
      background: linear-gradient(135deg, #4b2e2a 0%, #1b0f0d 100%);
      color:#fff; padding:1rem 0; position:sticky; top:0; z-index:1000;
      box-shadow:0 4px 20px rgba(0,0,0,0.28);
    }
    .nav-container{ max-width:1400px; margin:0 auto; padding:0 2rem; display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    .logo{ font-size:1.75rem; font-weight:900; color:#fff; text-decoration:none; cursor:pointer; user-select:none; }
    .nav-menu{ display:flex; list-style:none; gap:1.05rem; align-items:center; flex-wrap:wrap; }
    .nav-menu a{ color:#fff; text-decoration:none; font-weight:900; opacity:0.95; cursor:pointer; }
    .nav-menu a:hover{ opacity:1; text-decoration:underline; }

    .pill{
      border:1px solid rgba(255,255,255,0.25);
      padding:0.45rem 0.85rem; border-radius:999px;
      display:inline-flex; align-items:center; gap:0.5rem;
      cursor:pointer; user-select:none;
    }
    .pill:hover{ border-color: rgba(255,255,255,0.5); }
    .cart-count{ background:#e74c3c; color:#fff; border-radius:50%; width:20px; height:20px; font-size:0.75rem; display:inline-flex; align-items:center; justify-content:center; margin-left:0.35rem; }

    .hero{
      background:
        linear-gradient(135deg, rgba(0,0,0,0.58), rgba(0,0,0,0.25)),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600"><rect fill="%236b3f2a" width="1200" height="600"/></svg>');
      background-size:cover;
      color:#fff; padding:5.2rem 2rem 3.6rem; text-align:center;
    }
    .hero h1{ font-size:3rem; margin-bottom:0.8rem; font-weight:1000; }
    .hero p{ font-size:1.05rem; opacity:0.95; }

    .filter-section{ background:#f8f9fa; padding:1.1rem; border-bottom:2px solid #ddd; }
    .filter-container{ max-width:1400px; margin:0 auto; display:flex; gap:0.75rem; flex-wrap:wrap; padding:0 0.5rem; }
    .filter-btn{
      padding:0.65rem 1.15rem; border:2px solid #4b2e2a;
      background:#fff; color:#4b2e2a; border-radius:25px;
      cursor:pointer; font-weight:900;
    }
    .filter-btn.active{ background:#4b2e2a; color:#fff; }

    .products-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
      gap:1.6rem; max-width:1400px; margin:2rem auto 3rem; padding:0 2rem;
    }
    .product-card{
      background:#fff; border-radius:15px; overflow:hidden;
      box-shadow:0 5px 20px rgba(0,0,0,0.10);
      transition:all 0.25s;
    }
    .product-card:hover{ transform:translateY(-6px); }
    .product-image{ width:100%; height:320px; overflow:hidden; background:#f1f1f1; }
    .product-image img{ width:100%; height:100%; object-fit:cover; }

    .product-details{ padding:1.1rem 1.2rem 1.25rem; }
    .product-category{ font-size:0.82rem; color:#636e72; text-transform:uppercase; font-weight:900; }
    .product-name{ font-size:1.15rem; font-weight:1000; margin:0.35rem 0; }
    .product-price{ font-size:1.35rem; font-weight:1000; color:#e74c3c; margin:0.8rem 0 0.9rem; }

    .btn{ border:none; border-radius:10px; font-weight:1000; cursor:pointer; }
    .btn-dark{ background:#4b2e2a; color:#fff; padding:0.85rem; width:100%; }
    .btn-primary{
      padding:0.85rem 1rem;
      background: linear-gradient(135deg, #8b5a2b 0%, #4b2e2a 100%);
      color:#fff; border:none; border-radius:10px; font-weight:1000; cursor:pointer;
    }
    .btn-danger{ padding:0.7rem 1rem; background:#e74c3c; color:#fff; border:none; border-radius:10px; font-weight:1000; cursor:pointer; }
    .btn-ghost{ padding:0.7rem 1rem; background:#f1f3f5; color:#1a1a1a; border:none; border-radius:10px; font-weight:1000; cursor:pointer; }

    .hidden{ display:none !important; }
    .loading{ text-align:center; padding:3rem; font-size:1.1rem; color:#636e72; }

    .panel{ max-width:1100px; margin:2rem auto 3rem; padding:0 2rem; }
    .card{ background:#fff; border-radius:18px; box-shadow:0 10px 35px rgba(0,0,0,0.08); padding:1.25rem; }

    .admin-panel{ max-width:1000px; margin:2rem auto 3rem; padding:2rem; background:#fff; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.1); }
    .image-upload-area{ border:3px dashed #ddd; border-radius:12px; padding:2rem; text-align:center; cursor:pointer; }
    .image-preview{ max-width:100%; max-height:280px; margin-top:1rem; border-radius:10px; }
    .product-list{ margin-top:1.5rem; }
    .product-item{ background:#fff; padding:1rem; border-radius:14px; margin-bottom:1rem; box-shadow:0 3px 10px rgba(0,0,0,0.08); display:flex; gap:1rem; align-items:center; }
    .product-item-image{ width:92px; height:92px; border-radius:10px; overflow:hidden; background:#f1f1f1; }
    .product-item-image img{ width:100%; height:100%; object-fit:cover; }
    .product-item-details{ flex:1; }
    .product-actions{ display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end; }

    .modal-backdrop{
      position:fixed; inset:0; background: rgba(0,0,0,0.55);
      display:flex; align-items:center; justify-content:center;
      padding:1rem; z-index:2000;
    }
    .modal{
      width:min(560px, 100%);
      background:#fff; border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.25);
      padding:1.25rem;
    }
    .modal .muted{ color:#636e72; font-size:0.95rem; margin-bottom:1rem; }
    .modal .actions{ display:flex; gap:0.75rem; flex-wrap:wrap; margin-top:1rem; }
    .hr{ height:1px; background:#eee; margin:1rem 0; }
    .link{ color:#8b5a2b; font-weight:1000; cursor:pointer; }

    .drawer-backdrop{ position:fixed; inset:0; background: rgba(0,0,0,0.45); z-index:2500; display:flex; justify-content:flex-end; }
    .drawer{ width:min(420px, 100%); height:100%; background:#fff; padding:1rem; overflow:auto; box-shadow:-20px 0 60px rgba(0,0,0,0.2); }
    .cart-item{ display:flex; gap:0.75rem; padding:0.85rem 0; border-bottom:1px solid #eee; align-items:center; position:relative; }
    .cart-thumb{ width:72px; height:72px; border-radius:12px; overflow:hidden; background:#f1f1f1; flex:0 0 auto; }
    .cart-thumb img{ width:100%; height:100%; object-fit:cover; }
    .qty{ display:flex; align-items:center; gap:0.5rem; margin-top:0.35rem; }
    .qty button{ width:34px; height:34px; border-radius:10px; border:1px solid #ddd; background:#fff; font-weight:1000; cursor:pointer; }
    .qty span{ font-weight:1000; min-width:24px; text-align:center; display:inline-block; }
    .remove-x{
      position:absolute; top:10px; right:8px; width:30px; height:30px;
      border-radius:10px; border:1px solid rgba(231,76,60,0.35);
      background: rgba(231,76,60,0.08); color:#e74c3c; font-weight:1000;
      cursor:pointer; display:flex; align-items:center; justify-content:center; user-select:none;
    }

    .footer{ margin-top:2rem; background:#0b0b0b; color:#fff; padding:2rem 1.5rem; }
    .footer-inner{
      max-width:1400px; margin:0 auto;
      display:grid; grid-template-columns:1.2fr 1fr 1fr; gap:1.2rem;
    }
    .footer p, .footer a{ color: rgba(255,255,255,0.85); text-decoration:none; }
    .footer a:hover{ text-decoration:underline; }
    .footer-bottom{
      max-width:1400px; margin:1.25rem auto 0; padding-top:1rem;
      border-top:1px solid rgba(255,255,255,0.12);
      font-size:0.95rem; color: rgba(255,255,255,0.75);
    }
    @media (max-width:900px){ .footer-inner{ grid-template-columns:1fr; } }
    @media (max-width:768px){
      .hero h1{ font-size:2.1rem; }
      .products-grid{ padding:0 1rem; }
      .nav-container{ padding:0 1rem; }
    }

    input, textarea, select{
      width:100%;
      padding:0.75rem 0.85rem;
      border:1px solid #ddd;
      border-radius:12px;
      outline:none;
      margin-top:0.35rem;
    }
    label{ font-weight:900; color:#1a1a1a; display:block; margin-top:0.65rem; }
  </style>
</head>

<body>
  <header class="header">
    <nav class="nav-container">
      <a class="logo" onclick="showShop()">‚òï Yordi Coffee</a>

      <ul class="nav-menu">
        <li><a onclick="showShop()">Shop</a></li>
        <li><a onclick="openOrders()">My Orders</a></li>

        <!-- ‚úÖ Admin always visible; prompts key on click -->
        <li><a onclick="openAdmin()">Admin</a></li>

        <li>
          <div class="pill" onclick="openAccountMenu()">
            üë§ <span id="authLabel">Login</span>
          </div>
        </li>
        <li>
          <div class="pill" onclick="openCart()">
            üõí Cart <span class="cart-count" id="cartCount">0</span>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <section class="hero">
    <h1>Fresh Coffee, Delivered</h1>
    <p>Beans ‚Ä¢ Ground ‚Ä¢ Espresso ‚Ä¢ Traditional ‚Ä¢ Accessories</p>
  </section>

  <div class="filter-section" id="shopSection">
    <div class="filter-container">
      <button class="filter-btn active" onclick="filterProducts('all', this)">All</button>
      <button class="filter-btn" onclick="filterProducts('beans', this)">Beans</button>
      <button class="filter-btn" onclick="filterProducts('ground', this)">Ground</button>
      <button class="filter-btn" onclick="filterProducts('espresso', this)">Espresso</button>
      <button class="filter-btn" onclick="filterProducts('traditional', this)">Traditional</button>
      <button class="filter-btn" onclick="filterProducts('accessories', this)">Accessories</button>
    </div>
  </div>

  <div id="loadingProducts" class="loading">Loading coffee...</div>
  <div class="products-grid" id="productsGrid"></div>

  <!-- ORDERS -->
  <div id="ordersSection" class="panel hidden">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
        <h2>üì¶ My Orders</h2>
        <button class="btn-primary" onclick="showShop()">Back to Shop</button>
      </div>
      <p style="color:#636e72;margin-top:0.25rem;">Login required to view your order history.</p>
      <div id="ordersList" style="margin-top:1rem;"></div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="adminSection" class="panel hidden">
    <div class="admin-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
        <h2>üõ† Admin</h2>
        <button class="btn-ghost" onclick="showShop()">Back to Shop</button>
      </div>

      <div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin:0.75rem 0 1rem;">
        <button class="btn-primary" onclick="adminSetKey()">Set Admin Key</button>
        <button class="btn-ghost" onclick="adminTestKey()">Test Key</button>
        <button class="btn-danger" onclick="adminLogout()">Logout</button>
      </div>

      <p style="color:#636e72;margin-bottom:1.25rem;">
        Admin is protected by <b>ADMIN_API_KEY</b>. Key is stored only in your browser (localStorage).
      </p>

      <h3 style="margin-bottom:1rem;">Add New Coffee Item</h3>

      <form id="productForm">
        <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
          <p>üì∑ Upload Image (optional, max 2MB)</p>
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
          <img id="imagePreview" class="image-preview hidden" alt="Preview">
        </div>

        <label>Item Name</label>
        <input id="productName" required placeholder="e.g., Yirgacheffe Beans 1kg">

        <label>Description</label>
        <textarea id="productDescription" rows="3" placeholder="Taste notes, roast level, size..."></textarea>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:0.5rem;">
          <div>
            <label>Category</label>
            <select id="productCategory" required>
              <option value="beans">Beans</option>
              <option value="ground">Ground</option>
              <option value="espresso">Espresso</option>
              <option value="traditional">Traditional</option>
              <option value="accessories">Accessories</option>
            </select>
          </div>
          <div>
            <label>Price (ETB)</label>
            <input type="number" id="productPrice" step="0.01" required placeholder="e.g., 1200">
          </div>
        </div>

        <button class="btn-primary" id="addBtn" type="submit" style="width:100%;margin-top:1.2rem;">Add Item</button>
        <p id="adminStatus" style="margin-top:0.75rem;color:#636e72;font-weight:900;"></p>
      </form>

      <h3 style="margin-top:2rem;margin-bottom:1rem;">Manage Coffee</h3>
      <div class="product-list" id="productList"></div>

      <h3 style="margin-top:2rem;margin-bottom:1rem;">üì¶ Customer Orders (Admin Only)</h3>
      <div id="adminOrders" style="margin-top:0.75rem;"></div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal-backdrop hidden" onclick="if(event.target.id==='editModal') closeEditModal()">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
        <h2>Edit Item</h2>
        <button class="btn-ghost" onclick="closeEditModal()">‚úï</button>
      </div>

      <p class="muted">Update item details and optionally replace image.</p>

      <input id="editId" type="hidden" />

      <label>Name</label>
      <input id="editName" />

      <label>Description</label>
      <textarea id="editDescription" rows="3"></textarea>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div>
          <label>Category</label>
          <select id="editCategory">
            <option value="beans">Beans</option>
            <option value="ground">Ground</option>
            <option value="espresso">Espresso</option>
            <option value="traditional">Traditional</option>
            <option value="accessories">Accessories</option>
          </select>
        </div>
        <div>
          <label>Price (ETB)</label>
          <input id="editPrice" type="number" step="0.01" />
        </div>
      </div>

      <label>Replace Image (optional, max 2MB)</label>
      <input id="editImage" type="file" accept="image/*" />
      <img id="editPreview" class="image-preview hidden" alt="Preview" />

      <div class="hr"></div>

      <div class="actions">
        <button class="btn-primary" onclick="saveEditProduct()">Save</button>
        <button class="btn-danger" onclick="closeEditModal()">Cancel</button>
      </div>

      <p id="editMsg" style="margin-top:0.75rem;color:#e74c3c;font-weight:1000;"></p>
    </div>
  </div>

  <!-- CART DRAWER -->
  <div id="cartDrawer" class="drawer-backdrop hidden" onclick="if(event.target.id==='cartDrawer'){closeCart()}">
    <div class="drawer">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>üõí Cart</h2>
        <button class="btn btn-dark" style="width:auto;padding:0.5rem 0.75rem;" onclick="closeCart()">‚úï</button>
      </div>

      <div id="cartItems"></div>

      <div class="hr"></div>
      <div style="display:flex;justify-content:space-between;font-weight:1000;">
        <span>Subtotal</span>
        <span id="cartSubtotal">0 ETB</span>
      </div>

      <button class="btn btn-dark" style="width:100%;margin-top:1rem;" onclick="continueShopping()">Continue Shopping</button>
      <button class="btn-primary" style="width:100%;margin-top:0.6rem;" onclick="openCheckout()">Checkout</button>
      <button class="btn btn-dark" style="width:100%;margin-top:0.6rem;" onclick="clearCart()">Clear Cart</button>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutModal" class="modal-backdrop hidden" onclick="if(event.target.id==='checkoutModal') closeCheckout()">
    <div class="modal" style="width:min(720px,100%);">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>‚úÖ Checkout</h2>
        <button class="btn btn-dark" style="width:auto;padding:0.5rem 0.75rem;border-radius:10px;" onclick="closeCheckout()">‚úï</button>
      </div>
      <p class="muted">Fill your details and place your order.</p>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div>
          <label>Full Name</label>
          <input id="ckFullName" placeholder="Full name">
        </div>
        <div>
          <label>Phone</label>
          <input id="ckPhone" placeholder="+251...">
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div>
          <label>Email (optional)</label>
          <input id="ckEmail" placeholder="you@example.com">
        </div>
        <div>
          <label>City</label>
          <input id="ckCity" placeholder="Addis Ababa">
        </div>
      </div>

      <label>Address</label>
      <input id="ckAddress" placeholder="Street, building, etc...">

      <label>Country</label>
      <input id="ckCountry" value="Ethiopia">

      <label>Order Notes (optional)</label>
      <textarea id="ckNotes" rows="3" placeholder="Any special request..."></textarea>

      <div class="hr"></div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div>
          <label>Payment Method</label>
          <select id="ckPaymentMethod">
            <option value="cash">Cash on Delivery</option>
            <option value="card">Card</option>
            <option value="telebirr">Telebirr</option>
          </select>
        </div>
        <div>
          <label>Total</label>
          <input id="ckTotal" disabled>
        </div>
      </div>

      <label>Telebirr Reference (if Telebirr)</label>
      <input id="ckTelebirrRef" placeholder="TB123...">

      <div class="actions" style="margin-top:1rem;">
        <button class="btn-primary" onclick="placeOrder()">Place Order</button>
        <button class="btn btn-dark" style="width:auto;padding:0.85rem 1rem;" onclick="closeCheckout()">Cancel</button>
      </div>

      <p id="checkoutMsg" style="margin-top:0.75rem;color:#e74c3c;font-weight:1000;"></p>
    </div>
  </div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="modal-backdrop hidden" onclick="if(event.target.id==='authModal') closeAuth()">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2 id="authTitle">Login</h2>
        <button class="btn-ghost" onclick="closeAuth()">‚úï</button>
      </div>
      <p id="authSubtitle" class="muted">Login to see your orders and checkout faster.</p>

      <!-- LOGIN -->
      <div id="authFormLogin">
        <label>Email</label>
        <input id="loginEmail" placeholder="email@example.com" />

        <label>Password</label>
        <input id="loginPassword" type="password" placeholder="******" />

        <div class="actions">
          <button class="btn-primary" onclick="doLogin()">Login</button>
          <button class="btn-ghost" onclick="switchToRegister()">Create account</button>
        </div>

        <p id="authMsg" style="margin-top:0.75rem;color:#e74c3c;font-weight:1000;"></p>
      </div>

      <!-- REGISTER -->
      <div id="authFormRegister" class="hidden">
        <label>Full Name</label>
        <input id="regFullName" placeholder="Your name" />

        <label>Email</label>
        <input id="regEmail" placeholder="email@example.com" />

        <label>Password</label>
        <input id="regPassword" type="password" placeholder="min 6 chars" />

        <div class="actions">
          <button class="btn-primary" onclick="doRegister()">Register</button>
          <button class="btn-ghost" onclick="switchToLogin()">Back to login</button>
        </div>

        <p id="authMsg2" style="margin-top:0.75rem;color:#e74c3c;font-weight:1000;"></p>
      </div>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-inner">
      <div>
        <h3>‚òï Yordi Coffee</h3>
        <p>Fresh coffee products ‚Äî beans, ground coffee, espresso & accessories.</p>
      </div>

      <div>
        <h3>Support</h3>
        <p>Email: <a href="mailto:info@yordicoffee.com">info@yordicoffee.com</a></p>
      </div>

      <div>
        <h3>Hours</h3>
        <p>Mon‚ÄìSat: 8:00 AM ‚Äì 8:00 PM</p>
        <p>Sunday: Closed</p>
      </div>
    </div>

    <div class="footer-bottom">
      ¬© <span id="yy"></span> Yordi Coffee. All rights reserved.
    </div>
  </footer>

<script>
  // ‚úÖ Your deployed backend:
  const BACKEND_URL = "https://coffee-1-5gfb.onrender.com";

  const API_BASE =
    (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:3000"
      : BACKEND_URL;

  console.log("API_BASE:", API_BASE);

  let products = [];
  let currentFilter = "all";
  let cart = JSON.parse(localStorage.getItem("YORDI_CART") || "[]");

  // ---- Admin key ----
  const ADMIN_KEY_STORAGE = "YORDI_ADMIN_KEY";
  const getAdminKey = () => localStorage.getItem(ADMIN_KEY_STORAGE) || "";
  const setAdminKey = (k) => localStorage.setItem(ADMIN_KEY_STORAGE, k);
  const clearAdminKey = () => localStorage.removeItem(ADMIN_KEY_STORAGE);

  // ---- Auth token ----
  const AUTH_TOKEN_KEY = "YORDI_AUTH_TOKEN";
  const getToken = () => localStorage.getItem(AUTH_TOKEN_KEY) || "";
  const setToken = (t) => localStorage.setItem(AUTH_TOKEN_KEY, t);
  const clearToken = () => localStorage.removeItem(AUTH_TOKEN_KEY);

  // ---- Admin lock/unlock ----
  let adminUnlocked = false;

  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function formatMoney(n){ return (Number(n)||0).toFixed(0); }

  async function readJsonSafe(res){
    const text = await res.text();
    try { return { text, json: JSON.parse(text) }; }
    catch { return { text, json: null }; }
  }

  function saveCart(){
    localStorage.setItem("YORDI_CART", JSON.stringify(cart));
    updateCartCount();
  }

  function updateCartCount(){
    const count = cart.reduce((s, it) => s + (Number(it.qty)||1), 0);
    document.getElementById("cartCount").textContent = count;
  }

  function cartSubtotal(){
    return cart.reduce((s, it) => s + (Number(it.price)||0) * (Number(it.qty)||1), 0);
  }

  function showShop(){
    document.getElementById("ordersSection").classList.add("hidden");
    document.getElementById("adminSection").classList.add("hidden");
    document.getElementById("shopSection").scrollIntoView({ behavior:"smooth" });
  }

  function continueShopping(){ closeCart(); showShop(); }

  async function verifyAdminKey(key){
    const res = await fetch(API_BASE + "/api/admin/verify", {
      headers: { "x-admin-key": key }
    });
    return res.ok;
  }

  // ------------------ ADMIN ------------------
  async function adminSetKey(){
    const k = prompt("Enter ADMIN_API_KEY:");
    if(!k) return false;

    try{
      const ok = await verifyAdminKey(k.trim());
      if(!ok){
        alert("‚ùå Wrong admin key.");
        return false;
      }
      setAdminKey(k.trim());
      adminUnlocked = true;
      alert("‚úÖ Admin unlocked.");
      return true;
    }catch(e){
      alert("Verify error: " + e.message);
      return false;
    }
  }

  function adminLogout(){
    clearAdminKey();
    adminUnlocked = false;
    alert("‚úÖ Admin locked.");
  }

  async function adminTestKey(){
    const key = getAdminKey();
    if(!key) return alert("Admin key not set. Click 'Set Admin Key'.");

    const ok = await verifyAdminKey(key);
    if(!ok){
      clearAdminKey();
      adminUnlocked = false;
      return alert("‚ùå Key invalid. Please set again.");
    }
    alert("‚úÖ Admin key works.");
  }

  async function openAdmin(){
    // must be unlocked
    if(!adminUnlocked){
      const saved = getAdminKey();
      if(saved){
        const ok = await verifyAdminKey(saved);
        if(ok) adminUnlocked = true;
        else clearAdminKey();
      }
    }
    if(!adminUnlocked){
      const ok = await adminSetKey();
      if(!ok) return;
    }

    document.getElementById("ordersSection").classList.add("hidden");
    document.getElementById("adminSection").classList.remove("hidden");
    window.scrollTo({ top: document.getElementById("adminSection").offsetTop, behavior:"smooth" });

    renderAdminList();
    await loadAdminOrders();
  }

  // ------------------ ORDERS ------------------
  async function openOrders(){
    document.getElementById("adminSection").classList.add("hidden");
    document.getElementById("ordersSection").classList.remove("hidden");
    window.scrollTo({ top: document.getElementById("ordersSection").offsetTop, behavior:"smooth" });

    if(!getToken()){
      document.getElementById("ordersList").innerHTML =
        '<div style="padding:1rem;border:1px solid #eee;border-radius:14px;color:#636e72;">Please login to view orders. <span class="link" onclick="openAuth()">Login</span></div>';
      return;
    }
    await loadMyOrders();
  }

  // ------------------ PRODUCTS ------------------
  async function loadProducts(){
    const loading = document.getElementById("loadingProducts");
    const url = API_BASE + "/api/coffee";
    loading.classList.remove("hidden");
    loading.innerHTML = "Loading coffee...";

    try {
      const res = await fetch(url, { cache: "no-store" });
      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(`Backend ${res.status}: ${json?.details || json?.error || text || "Unknown error"}`);
      products = Array.isArray(json) ? json : [];
      loading.classList.add("hidden");
      renderProducts();
      renderAdminList();
    } catch (err) {
      console.error(err);
      loading.innerHTML = `
        <p style="color:#e74c3c;font-weight:900;">Failed to load coffee from backend.</p>
        <p style="color:#636e72;margin-top:0.5rem;">
          API_BASE: <b>${escapeHtml(API_BASE)}</b><br/>
          URL: <b>${escapeHtml(url)}</b><br/>
          Error: <b>${escapeHtml(err.message || String(err))}</b>
        </p>
        <div style="margin-top:0.75rem;">
          <button class="btn-primary" onclick="loadProducts()">Retry</button>
        </div>
      `;
    }
  }

  function filterProducts(category, btnEl){
    currentFilter = category;
    document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
    if (btnEl) btnEl.classList.add("active");
    renderProducts();
  }

  function renderProducts(){
    const grid = document.getElementById("productsGrid");
    const filtered = (currentFilter === "all")
      ? products
      : products.filter(p => String(p.category || "") === String(currentFilter));

    if (!filtered.length) {
      grid.innerHTML = `<div style="padding:1rem;color:#636e72;">No items found.</div>`;
      return;
    }

    grid.innerHTML = filtered.map(p => `
      <div class="product-card">
        <div class="product-image">
          <img src="${p.image || ''}" alt="${escapeHtml(p.name || 'Coffee')}" onerror="this.style.display='none'">
        </div>
        <div class="product-details">
          <div class="product-category">${escapeHtml(p.category || '')}</div>
          <div class="product-name">${escapeHtml(p.name || '')}</div>
          ${p.description ? `<p style="font-size:0.95rem;color:#636e72;margin:0.4rem 0;">${escapeHtml(p.description)}</p>` : ""}
          <div class="product-price">${formatMoney(p.price)} ETB</div>
          <button class="btn btn-dark" onclick="addToCart('${String(p._id)}')">Add to Cart</button>
        </div>
      </div>
    `).join("");
  }

  function addToCart(mongoId){
    const p = products.find(x => String(x._id) === String(mongoId));
    if(!p) return alert("Item not found");

    const existing = cart.find(x => String(x.productId) === String(mongoId));
    if(existing) existing.qty = (Number(existing.qty)||1) + 1;
    else cart.push({ productId: String(p._id), name: p.name, price: Number(p.price)||0, qty: 1, image: p.image || "" });

    saveCart();
    openCart();
  }

  // ------------------ CART ------------------
  function removeFromCart(productId){
    cart = cart.filter(x => String(x.productId) !== String(productId));
    saveCart();
    renderCart();
  }

  function changeQty(productId, delta){
    const it = cart.find(x => String(x.productId) === String(productId));
    if(!it) return;
    it.qty = Math.max(1, (Number(it.qty)||1) + delta);
    saveCart();
    renderCart();
  }

  function clearCart(){
    if(!confirm("Clear cart?")) return;
    cart = [];
    saveCart();
    renderCart();
  }

  function openCart(){
    document.getElementById("cartDrawer").classList.remove("hidden");
    renderCart();
  }

  function closeCart(){
    document.getElementById("cartDrawer").classList.add("hidden");
  }

  function renderCart(){
    const box = document.getElementById("cartItems");
    if(cart.length === 0){
      box.innerHTML = `<div style="padding:1rem;color:#636e72;border:1px solid #eee;border-radius:14px;margin-top:1rem;">Your cart is empty.</div>`;
      document.getElementById("cartSubtotal").textContent = "0 ETB";
      return;
    }

    box.innerHTML = cart.map(it => `
      <div class="cart-item">
        <div class="cart-thumb"><img src="${it.image || ''}" onerror="this.style.display='none'"></div>
        <div style="flex:1;">
          <div style="font-weight:1000;">${escapeHtml(it.name || "")}</div>
          <div style="color:#e74c3c;font-weight:1000;margin-top:0.2rem;">${formatMoney(it.price)} ETB</div>
          <div class="qty">
            <button onclick="changeQty('${escapeHtml(it.productId)}', -1)">-</button>
            <span>${Number(it.qty)||1}</span>
            <button onclick="changeQty('${escapeHtml(it.productId)}', 1)">+</button>
          </div>
        </div>
        <div class="remove-x" title="Remove" onclick="removeFromCart('${escapeHtml(it.productId)}')">‚úï</div>
      </div>
    `).join("");

    document.getElementById("cartSubtotal").textContent = `${formatMoney(cartSubtotal())} ETB`;
  }

  // ------------------ CHECKOUT ------------------
  function openCheckout(){
    if(cart.length === 0) return alert("Cart is empty");
    if(!getToken()){
      alert("Please login first to checkout.");
      openAuth();
      return;
    }
    document.getElementById("checkoutMsg").textContent = "";
    document.getElementById("ckTotal").value = formatMoney(cartSubtotal()) + " ETB";
    document.getElementById("checkoutModal").classList.remove("hidden");
  }
  function closeCheckout(){ document.getElementById("checkoutModal").classList.add("hidden"); }

  async function placeOrder(){
    const msgEl = document.getElementById("checkoutMsg");
    msgEl.textContent = "";

    const fullName = document.getElementById("ckFullName").value.trim();
    const phone = document.getElementById("ckPhone").value.trim();
    const email = document.getElementById("ckEmail").value.trim();
    const address = document.getElementById("ckAddress").value.trim();
    const city = document.getElementById("ckCity").value.trim();
    const country = document.getElementById("ckCountry").value.trim();
    const notes = document.getElementById("ckNotes").value.trim();
    const paymentMethod = document.getElementById("ckPaymentMethod").value;
    const telebirrRef = document.getElementById("ckTelebirrRef").value.trim();

    if(!fullName) return msgEl.textContent = "Full name is required";
    if(!phone) return msgEl.textContent = "Phone is required";
    if(!address) return msgEl.textContent = "Address is required";

    const payload = {
      items: cart.map(it => ({ productId: it.productId, name: it.name, price: it.price, qty: it.qty, image: it.image || "" })),
      fullName, phone, email, address, city, country, notes,
      paymentMethod, telebirrRef
    };

    try{
      const res = await fetch(API_BASE + "/api/orders", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + getToken()
        },
        body: JSON.stringify(payload)
      });
      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(json?.details || json?.error || text || "Order failed");

      alert("‚úÖ Order placed! Order ID: " + (json?.order?.orderId || ""));
      closeCheckout();
      closeCart();
      cart = [];
      saveCart();
      await openOrders();
    }catch(e){
      msgEl.textContent = e.message;
    }
  }

  // ------------------ AUTH ------------------
  function openAuth(){ document.getElementById("authModal").classList.remove("hidden"); switchToLogin(); }
  function closeAuth(){ document.getElementById("authModal").classList.add("hidden"); }

  function switchToRegister(){
    document.getElementById("authTitle").textContent = "Create Account";
    document.getElementById("authSubtitle").textContent = "Register to track your orders anytime.";
    document.getElementById("authFormLogin").classList.add("hidden");
    document.getElementById("authFormRegister").classList.remove("hidden");
    document.getElementById("authMsg").textContent = "";
    document.getElementById("authMsg2").textContent = "";
  }

  function switchToLogin(){
    document.getElementById("authTitle").textContent = "Login";
    document.getElementById("authSubtitle").textContent = "Login to see your orders and checkout faster.";
    document.getElementById("authFormRegister").classList.add("hidden");
    document.getElementById("authFormLogin").classList.remove("hidden");
    document.getElementById("authMsg").textContent = "";
    document.getElementById("authMsg2").textContent = "";
  }

  function setAuthLabel(){
    document.getElementById("authLabel").textContent = getToken() ? "Account" : "Login";
  }

  function openAccountMenu(){
    if(!getToken()){ openAuth(); return; }
    const choice = prompt("Type: 1 = My Orders, 2 = Logout");
    if(choice === "1") openOrders();
    if(choice === "2"){ clearToken(); setAuthLabel(); alert("Logged out."); }
  }

  async function doRegister(){
    const msg = document.getElementById("authMsg2");
    msg.textContent = "";
    const fullName = document.getElementById("regFullName").value.trim();
    const email = document.getElementById("regEmail").value.trim();
    const password = document.getElementById("regPassword").value;

    try{
      const res = await fetch(API_BASE + "/api/auth/register", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ fullName, email, password })
      });
      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(json?.details || json?.error || text || "Register failed");
      setToken(json.token);
      setAuthLabel();
      closeAuth();
      alert("‚úÖ Account created! You are logged in.");
    }catch(e){ msg.textContent = e.message; }
  }

  async function doLogin(){
    const msg = document.getElementById("authMsg");
    msg.textContent = "";
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value;

    try{
      const res = await fetch(API_BASE + "/api/auth/login", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ email, password })
      });
      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(json?.details || json?.error || text || "Login failed");
      setToken(json.token);
      setAuthLabel();
      closeAuth();
      alert("‚úÖ Logged in!");
    }catch(e){ msg.textContent = e.message; }
  }

  async function loadMyOrders(){
    const box = document.getElementById("ordersList");
    box.innerHTML = `<div style="padding:1rem;color:#636e72;border:1px solid #eee;border-radius:14px;">Loading...</div>`;

    try{
      const res = await fetch(API_BASE + "/api/orders/my", {
        headers: { "Authorization": "Bearer " + getToken() }
      });
      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(json?.details || json?.error || text || "Failed to load orders");

      const orders = Array.isArray(json) ? json : [];
      if(orders.length === 0){
        box.innerHTML = `<div style="padding:1rem;color:#636e72;border:1px solid #eee;border-radius:14px;">No orders yet.</div>`;
        return;
      }

      box.innerHTML = orders.map(o => {
        const itemsHtml = (o.items || []).map(it => `
          <div style="display:flex;gap:0.75rem;align-items:center;padding:0.5rem 0;border-bottom:1px solid #f3f3f3;">
            <div style="flex:1;">
              <div style="font-weight:1000;">${escapeHtml(it.name || "")}</div>
              <div style="color:#636e72;font-weight:900;font-size:0.95rem;">Qty: ${Number(it.qty)||1} ‚Ä¢ ${formatMoney(it.price)} ETB</div>
            </div>
          </div>
        `).join("");

        return `
          <div style="border:1px solid #eee;border-radius:16px;padding:1rem;margin-bottom:1rem;">
            <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
              <div>
                <div style="font-weight:1000;font-size:1.05rem;">Order: ${escapeHtml(o.orderId || "")}</div>
                <div style="color:#636e72;font-weight:900;font-size:0.95rem;">
                  Status: ${escapeHtml(o.status || "placed")} ‚Ä¢ Payment: ${escapeHtml(o.payment?.method || "")} (${escapeHtml(o.payment?.status || "pending")})
                </div>
              </div>
              <div style="font-weight:1000;color:#e74c3c;font-size:1.05rem;">${formatMoney(o.total)} ETB</div>
            </div>

            <div style="margin-top:0.75rem;">${itemsHtml}</div>

            <div style="margin-top:0.75rem;color:#636e72;font-weight:900;font-size:0.95rem;">
              Placed: ${new Date(o.createdAt).toLocaleString()}
            </div>
          </div>
        `;
      }).join("");
    }catch(e){
      box.innerHTML = `<div style="padding:1rem;color:#e74c3c;border:1px solid #eee;border-radius:14px;">${escapeHtml(e.message)}</div>`;
    }
  }

  // ------------------ ADMIN ORDERS ------------------
  async function loadAdminOrders(){
    const box = document.getElementById("adminOrders");
    const key = getAdminKey();
    if(!key){
      box.innerHTML = `<div style="padding:1rem;border:1px solid #eee;border-radius:14px;color:#636e72;">
        Admin key not set. Click <b>Set Admin Key</b>.
      </div>`;
      return;
    }

    box.innerHTML = `<div style="padding:1rem;border:1px solid #eee;border-radius:14px;color:#636e72;">Loading orders...</div>`;

    try{
      const res = await fetch(API_BASE + "/api/admin/orders", {
        headers: { "x-admin-key": key }
      });
      const { text, json } = await readJsonSafe(res);

      if(res.status === 401){
        clearAdminKey();
        adminUnlocked = false;
        throw new Error("Admin key invalid. Please open Admin again.");
      }
      if(!res.ok) throw new Error(json?.details || json?.error || text || "Failed to load admin orders");

      const orders = Array.isArray(json) ? json : [];
      if(orders.length === 0){
        box.innerHTML = `<div style="padding:1rem;border:1px solid #eee;border-radius:14px;color:#636e72;">No orders yet.</div>`;
        return;
      }

      box.innerHTML = orders.map(o => {
        const c = o.customer || {};
        const payMethod = o.payment?.method || "";
        const payStatus = o.payment?.status || "pending";

        const itemsHtml = (o.items || []).map(it => `
          <div style="display:flex;gap:0.75rem;align-items:center;padding:0.6rem 0;border-bottom:1px solid #f3f3f3;">
            <div style="width:60px;height:60px;border-radius:12px;overflow:hidden;background:#f1f1f1;flex:0 0 auto;">
              <img src="${it.image || ""}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'">
            </div>
            <div style="flex:1;">
              <div style="font-weight:1000;">${escapeHtml(it.name || "")}</div>
              <div style="color:#636e72;font-weight:900;font-size:0.95rem;">
                Qty: ${Number(it.qty)||1} ‚Ä¢ ${formatMoney(it.price)} ETB
              </div>
            </div>
          </div>
        `).join("");

        return `
          <div style="border:1px solid #eee;border-radius:16px;padding:1rem;margin-bottom:1rem;">
            <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;">
              <div>
                <div style="font-weight:1000;font-size:1.05rem;">Order: ${escapeHtml(o.orderId || "")}</div>
                <div style="color:#636e72;font-weight:900;font-size:0.95rem;">
                  Status: <b>${escapeHtml(o.status || "placed")}</b> ‚Ä¢ Payment: <b>${escapeHtml(payMethod)}</b> (<b>${escapeHtml(payStatus)}</b>)
                </div>
                <div style="margin-top:0.4rem;color:#636e72;font-weight:900;font-size:0.95rem;">
                  Customer: <b>${escapeHtml(c.fullName || "")}</b> ‚Ä¢ ${escapeHtml(c.phone || "")} ‚Ä¢ ${escapeHtml(c.email || "")}<br>
                  Address: ${escapeHtml(c.address || "")}, ${escapeHtml(c.city || "")}, ${escapeHtml(c.country || "")}
                </div>
              </div>
              <div style="font-weight:1000;color:#e74c3c;font-size:1.05rem;">${formatMoney(o.total)} ETB</div>
            </div>

            <div style="margin-top:0.75rem;">${itemsHtml}</div>

            <div style="margin-top:0.75rem;display:flex;gap:0.6rem;flex-wrap:wrap;align-items:center;">
              <select id="st_${o._id}" class="btn-ghost" style="padding:0.6rem 0.8rem;border:1px solid #ddd;">
                ${["placed","processing","delivered","cancelled"].map(s => `
                  <option value="${s}" ${String(o.status)===s ? "selected" : ""}>${s}</option>
                `).join("")}
              </select>

              <select id="pay_${o._id}" class="btn-ghost" style="padding:0.6rem 0.8rem;border:1px solid #ddd;">
                ${["pending","paid","failed"].map(s => `
                  <option value="${s}" ${String(payStatus)===s ? "selected" : ""}>${s}</option>
                `).join("")}
              </select>

              <button class="btn-primary" onclick="adminUpdateOrder('${o._id}')">Save</button>
            </div>

            <div style="margin-top:0.75rem;display:flex;gap:0.75rem;flex-wrap:wrap;align-items:center;">
              <select id="mailtpl_${o._id}" class="btn-ghost" style="padding:0.6rem 0.8rem;border:1px solid #ddd;">
                <option value="paid">Payment Confirmed (Paid)</option>
                <option value="failed">Payment Failed</option>
                <option value="processing">Order Processing</option>
                <option value="delivered">Delivered</option>
                <option value="custom">Custom</option>
              </select>

              <input id="mailmsg_${o._id}" placeholder="Optional message to customer..." style="flex:1;min-width:240px;"/>

              <button class="btn-ghost" onclick="adminEmailCustomer('${o._id}')">Email Customer</button>
            </div>

            <div style="margin-top:0.6rem;color:#636e72;font-weight:900;font-size:0.95rem;">
              Placed: ${new Date(o.createdAt).toLocaleString()}
            </div>
          </div>
        `;
      }).join("");

    }catch(e){
      box.innerHTML = `<div style="padding:1rem;border:1px solid #eee;border-radius:14px;color:#e74c3c;">
        ${escapeHtml(e.message)}
      </div>`;
    }
  }

  async function adminUpdateOrder(id){
    const key = getAdminKey();
    if(!key) return alert("Admin key not set.");

    const status = document.getElementById("st_" + id).value;
    const paymentStatus = document.getElementById("pay_" + id).value;

    try{
      const res = await fetch(API_BASE + "/api/admin/orders/" + encodeURIComponent(id), {
        method: "PUT",
        headers: {
          "Content-Type":"application/json",
          "x-admin-key": key
        },
        body: JSON.stringify({ status, paymentStatus })
      });
      const { text, json } = await readJsonSafe(res);
      if(res.status === 401) throw new Error("Unauthorized admin key.");
      if(!res.ok) throw new Error(json?.details || json?.error || text || "Update failed");

      alert("‚úÖ Order updated!");
      await loadAdminOrders();
    }catch(e){
      alert("Update error: " + e.message);
    }
  }

  // ‚úÖ‚úÖ‚úÖ UPDATED: this now shows the REAL backend error details
async function adminEmailCustomer(id){
  const key = getAdminKey();
  if(!key) return alert("Admin key required.");

  const tpl = document.getElementById("mailtpl_" + id).value;
  const message = document.getElementById("mailmsg_" + id).value.trim();

  // ‚úÖ quick health check first
  try{
    const ping = await fetch(API_BASE + "/api/health", { cache: "no-store" });
    if(!ping.ok) throw new Error("Backend not reachable (health check failed).");
  }catch(e){
    alert("Backend fetch failed. Check API_BASE and Render status.\n\n" + e.message);
    return;
  }

  try{
    const res = await fetch(API_BASE + "/api/admin/orders/" + encodeURIComponent(id) + "/email", {
      method: "POST",
      headers: {
        "Content-Type":"application/json",
        "x-admin-key": key
      },
      body: JSON.stringify({ template: tpl, message })
    });

    const text = await res.text();
    let json = null;
    try{ json = JSON.parse(text); }catch{}

    if(res.status === 401){
      clearAdminKey();
      adminUnlocked = false;
      throw new Error("Unauthorized admin key. Please open Admin again.");
    }
    if(!res.ok) throw new Error(json?.details || json?.error || text || "Email failed");

    alert("‚úÖ Email sent to customer!");
  }catch(e){
    alert("Email error: " + e.message);
  }
}


  // ------------------ ADMIN COFFEE LIST ------------------
  function renderAdminList(){
    const list = document.getElementById("productList");
    if(!list) return;
    if(!products.length){
      list.innerHTML = '<p style="color:#636e72;padding:1rem;">No items yet.</p>';
      return;
    }

    list.innerHTML = products.map(p => `
      <div class="product-item">
        <div class="product-item-image">
          <img src="${p.image || ''}" alt="${escapeHtml(p.name || '')}" onerror="this.style.display='none'">
        </div>
        <div class="product-item-details">
          <h3>${escapeHtml(p.name || '')}</h3>
          <p><b>Category:</b> ${escapeHtml(p.category || '')}</p>
          <p><b>Price:</b> ${formatMoney(p.price)} ETB</p>
        </div>
        <div class="product-actions">
          <button class="btn-ghost" onclick="openEditProduct('${String(p._id)}')">Edit</button>
          <button class="btn-danger" onclick="deleteProduct('${String(p._id)}')">Delete</button>
        </div>
      </div>
    `).join("");
  }

  async function fileToBase64(file){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function setAdminStatus(msg, isError=false){
    const el = document.getElementById("adminStatus");
    if(!el) return;
    el.textContent = msg || "";
    el.style.color = isError ? "#e74c3c" : "#636e72";
  }

  async function addProduct(formEl){
    const key = getAdminKey();
    if(!key) return alert("Admin key not set. Click 'Set Admin Key'.");

    const file = document.getElementById("imageInput").files[0];
    if (file && file.size > 2 * 1024 * 1024) return alert("Image too large (max 2MB).");

    const payload = {
      name: document.getElementById("productName").value.trim(),
      description: document.getElementById("productDescription").value.trim(),
      category: document.getElementById("productCategory").value,
      price: Number(document.getElementById("productPrice").value),
      image: ""
    };

    if(!payload.name) return alert("Name is required");
    if(!payload.price) return alert("Price is required");

    if(file) payload.image = await fileToBase64(file);

    const btn = document.getElementById("addBtn");
    btn.disabled = true;
    btn.textContent = "Saving...";
    setAdminStatus("Saving coffee...");

    try{
      const res = await fetch(API_BASE + "/api/coffee", {
        method: "POST",
        headers: { "Content-Type":"application/json", "x-admin-key": key },
        body: JSON.stringify(payload)
      });
      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(json?.details || json?.error || text || "Failed to add item");
      alert("‚úÖ Coffee item added!");
      setAdminStatus("Saved ‚úÖ");
      formEl.reset();
      document.getElementById("imagePreview").classList.add("hidden");
      await loadProducts();
    }catch(e){
      setAdminStatus("Error: " + e.message, true);
      alert("Add error: " + e.message);
    }finally{
      btn.disabled = false;
      btn.textContent = "Add Item";
    }
  }

  function openEditProduct(id){
    const p = products.find(x => String(x._id) === String(id));
    if(!p) return alert("Item not found");

    document.getElementById("editMsg").textContent = "";
    document.getElementById("editId").value = p._id;
    document.getElementById("editName").value = p.name || "";
    document.getElementById("editPrice").value = Number(p.price) || 0;
    document.getElementById("editDescription").value = p.description || "";
    document.getElementById("editCategory").value = p.category || "beans";

    const prev = document.getElementById("editPreview");
    if(p.image){
      prev.src = p.image;
      prev.classList.remove("hidden");
    } else {
      prev.classList.add("hidden");
    }

    document.getElementById("editImage").value = "";
    document.getElementById("editModal").classList.remove("hidden");
  }

  function closeEditModal(){ document.getElementById("editModal").classList.add("hidden"); }

  async function saveEditProduct(){
    const key = getAdminKey();
    if(!key) return alert("Admin key not set. Click 'Set Admin Key'.");

    const id = document.getElementById("editId").value;
    const name = document.getElementById("editName").value.trim();
    const price = Number(document.getElementById("editPrice").value);
    const description = document.getElementById("editDescription").value.trim();
    const category = document.getElementById("editCategory").value;
    const file = document.getElementById("editImage").files[0];

    const msg = document.getElementById("editMsg");
    msg.textContent = "";

    if(!name) return msg.textContent = "Name is required";
    if(!price) return msg.textContent = "Price is required";
    if(file && file.size > 2 * 1024 * 1024) return msg.textContent = "Image too large (max 2MB)";

    const payload = { name, price, description, category };
    if(file) payload.image = await fileToBase64(file);

    try{
      const res = await fetch(API_BASE + "/api/coffee/" + encodeURIComponent(id), {
        method: "PUT",
        headers: { "Content-Type":"application/json", "x-admin-key": key },
        body: JSON.stringify(payload)
      });
      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(json?.details || json?.error || text || "Update failed");

      alert("‚úÖ Updated!");
      closeEditModal();
      await loadProducts();
    }catch(e){
      msg.textContent = e.message;
    }
  }

  async function deleteProduct(id){
    const key = getAdminKey();
    if(!key) return alert("Admin key not set. Click 'Set Admin Key'.");
    if(!confirm("Delete this item?")) return;

    try{
      const res = await fetch(API_BASE + "/api/coffee/" + encodeURIComponent(id), {
        method: "DELETE",
        headers: { "x-admin-key": key }
      });
      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(json?.details || json?.error || text || "Delete failed");
      alert("‚úÖ Deleted!");
      await loadProducts();
    }catch(e){
      alert("Delete error: " + e.message);
    }
  }

  // previews
  document.addEventListener("change", (e) => {
    if(e.target && e.target.id === "imageInput"){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.getElementById("imagePreview");
        img.src = ev.target.result;
        img.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }

    if(e.target && e.target.id === "editImage"){
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.getElementById("editPreview");
        img.src = ev.target.result;
        img.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    }
  });

  document.addEventListener("DOMContentLoaded", async () => {
    document.getElementById("yy").textContent = new Date().getFullYear();

    // If key exists, try auto-unlock
    const savedKey = getAdminKey();
    if(savedKey){
      try{
        const ok = await verifyAdminKey(savedKey);
        adminUnlocked = ok;
        if(!ok) clearAdminKey();
      }catch{
        adminUnlocked = false;
      }
    }

    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await addProduct(e.target);
    });

    updateCartCount();
    setAuthLabel();
    loadProducts();
  });
</script>
</body>
</html>
