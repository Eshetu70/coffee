<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yordi Coffee - Online Shopping</title>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height:1.6; color:#1a1a1a; background:#fff; }

    .header{
      background: linear-gradient(135deg, #4b2e2a 0%, #1b0f0d 100%);
      color:#fff; padding:1rem 0; position:sticky; top:0; z-index:1000;
      box-shadow:0 4px 20px rgba(0,0,0,0.28);
    }
    .nav-container{ max-width:1400px; margin:0 auto; padding:0 2rem; display:flex; justify-content:space-between; align-items:center; gap:1rem; }
    .logo{ font-size:1.75rem; font-weight:900; color:#fff; text-decoration:none; cursor:pointer; user-select:none; }
    .nav-menu{ display:flex; list-style:none; gap:1.25rem; align-items:center; flex-wrap:wrap; }
    .nav-menu a{ color:#fff; text-decoration:none; font-weight:800; opacity:0.95; cursor:pointer; }
    .nav-menu a:hover{ opacity:1; text-decoration:underline; }

    .pill{
      border:1px solid rgba(255,255,255,0.25);
      padding:0.45rem 0.85rem; border-radius:999px;
      display:inline-flex; align-items:center; gap:0.5rem;
      cursor:pointer; user-select:none;
    }
    .pill:hover{ border-color: rgba(255,255,255,0.5); }
    .cart-count{
      background:#e74c3c; color:#fff; border-radius:50%;
      width:20px; height:20px; font-size:0.75rem;
      display:inline-flex; align-items:center; justify-content:center;
      margin-left:0.35rem;
    }

    .hero{
      background:
        linear-gradient(135deg, rgba(0,0,0,0.58), rgba(0,0,0,0.25)),
        url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 600"><rect fill="%236b3f2a" width="1200" height="600"/></svg>');
      background-size:cover;
      color:#fff; padding:5.5rem 2rem 3.5rem; text-align:center;
    }
    .hero h1{ font-size:3rem; margin-bottom:0.8rem; font-weight:1000; }
    .hero p{ font-size:1.05rem; opacity:0.95; }

    .filter-section{ background:#f8f9fa; padding:1.1rem; border-bottom:2px solid #ddd; }
    .filter-container{ max-width:1400px; margin:0 auto; display:flex; gap:0.75rem; flex-wrap:wrap; padding:0 0.5rem; }
    .filter-btn{
      padding:0.65rem 1.15rem; border:2px solid #4b2e2a;
      background:#fff; color:#4b2e2a; border-radius:25px;
      cursor:pointer; font-weight:900;
    }
    .filter-btn.active{ background:#4b2e2a; color:#fff; }

    .products-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
      gap:1.6rem; max-width:1400px; margin:2rem auto 3rem; padding:0 2rem;
    }
    .product-card{
      background:#fff; border-radius:15px; overflow:hidden;
      box-shadow:0 5px 20px rgba(0,0,0,0.10);
      transition:all 0.25s;
    }
    .product-card:hover{ transform:translateY(-6px); }
    .product-image{ width:100%; height:320px; overflow:hidden; background:#f1f1f1; }
    .product-image img{ width:100%; height:100%; object-fit:cover; }

    .product-details{ padding:1.1rem 1.2rem 1.25rem; }
    .product-category{ font-size:0.82rem; color:#636e72; text-transform:uppercase; font-weight:900; }
    .product-name{ font-size:1.15rem; font-weight:1000; margin:0.35rem 0; }
    .product-price{ font-size:1.35rem; font-weight:1000; color:#e74c3c; margin:0.8rem 0 0.9rem; }

    .btn{ border:none; border-radius:10px; font-weight:1000; cursor:pointer; }
    .btn-dark{ background:#4b2e2a; color:#fff; padding:0.85rem; width:100%; }
    .btn-primary{
      padding:0.85rem 1rem;
      background: linear-gradient(135deg, #8b5a2b 0%, #4b2e2a 100%);
      color:#fff; border:none; border-radius:10px; font-weight:1000; cursor:pointer;
    }
    .btn-danger{ padding:0.7rem 1rem; background:#e74c3c; color:#fff; border:none; border-radius:10px; font-weight:1000; cursor:pointer; }
    .btn-ghost{ padding:0.7rem 1rem; background:#f1f3f5; color:#1a1a1a; border:none; border-radius:10px; font-weight:1000; cursor:pointer; }

    .hidden{ display:none !important; }
    .loading{ text-align:center; padding:3rem; font-size:1.1rem; color:#636e72; }

    .admin-panel{ max-width:900px; margin:3rem auto; padding:2rem; background:#fff; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.1); }
    .image-upload-area{ border:3px dashed #ddd; border-radius:12px; padding:2rem; text-align:center; cursor:pointer; }
    .image-preview{ max-width:100%; max-height:280px; margin-top:1rem; border-radius:10px; }
    .product-list{ margin-top:1.5rem; }
    .product-item{ background:#fff; padding:1rem; border-radius:14px; margin-bottom:1rem; box-shadow:0 3px 10px rgba(0,0,0,0.08); display:flex; gap:1rem; align-items:center; }
    .product-item-image{ width:92px; height:92px; border-radius:10px; overflow:hidden; background:#f1f1f1; }
    .product-item-image img{ width:100%; height:100%; object-fit:cover; }
    .product-item-details{ flex:1; }
    .product-actions{ display:flex; gap:0.5rem; flex-wrap:wrap; justify-content:flex-end; }

    .modal-backdrop{
      position:fixed; inset:0; background: rgba(0,0,0,0.55);
      display:flex; align-items:center; justify-content:center;
      padding:1rem; z-index:2000;
    }
    .modal{
      width:min(720px, 100%);
      background:#fff; border-radius:18px;
      box-shadow:0 20px 60px rgba(0,0,0,0.25);
      padding:1.25rem;
    }
    .modal .muted{ color:#636e72; font-size:0.95rem; margin-bottom:1rem; }
    .modal .actions{ display:flex; gap:0.75rem; flex-wrap:wrap; margin-top:1rem; }
    .hr{ height:1px; background:#eee; margin:1rem 0; }

    /* Cart Drawer */
    .drawer-backdrop{ position:fixed; inset:0; background: rgba(0,0,0,0.45); z-index:2500; display:flex; justify-content:flex-end; }
    .drawer{ width:min(420px, 100%); height:100%; background:#fff; padding:1rem; overflow:auto; box-shadow:-20px 0 60px rgba(0,0,0,0.2); }
    .cart-item{ display:flex; gap:0.75rem; padding:0.85rem 0; border-bottom:1px solid #eee; align-items:center; position:relative; }
    .cart-thumb{ width:72px; height:72px; border-radius:12px; overflow:hidden; background:#f1f1f1; flex:0 0 auto; }
    .cart-thumb img{ width:100%; height:100%; object-fit:cover; }
    .qty{ display:flex; align-items:center; gap:0.5rem; margin-top:0.35rem; }
    .qty button{ width:34px; height:34px; border-radius:10px; border:1px solid #ddd; background:#fff; font-weight:1000; cursor:pointer; }
    .qty span{ font-weight:1000; min-width:24px; text-align:center; display:inline-block; }
    .remove-x{
      position:absolute; top:10px; right:8px; width:30px; height:30px;
      border-radius:10px; border:1px solid rgba(231,76,60,0.35);
      background: rgba(231,76,60,0.08); color:#e74c3c; font-weight:1000;
      cursor:pointer; display:flex; align-items:center; justify-content:center; user-select:none;
    }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    @media (max-width:900px){ .row{ grid-template-columns:1fr; } }
    label{ font-weight:900; font-size:0.95rem; }
    input, textarea, select{
      width:100%; padding:0.85rem; border:2px solid #ddd; border-radius:10px;
      font-size:1rem; outline:none;
    }
    input:focus, textarea:focus, select:focus{ border-color:#8b5a2b; }

    .footer{ margin-top:2rem; background:#0b0b0b; color:#fff; padding:2rem 1.5rem; }
    .footer-inner{
      max-width:1400px; margin:0 auto;
      display:grid; grid-template-columns:1.2fr 1fr 1fr; gap:1.2rem;
    }
    .footer p, .footer a{ color: rgba(255,255,255,0.85); text-decoration:none; }
    .footer a:hover{ text-decoration:underline; }
    .footer-bottom{
      max-width:1400px; margin:1.25rem auto 0; padding-top:1rem;
      border-top:1px solid rgba(255,255,255,0.12);
      font-size:0.95rem; color: rgba(255,255,255,0.75);
    }
    @media (max-width:900px){ .footer-inner{ grid-template-columns:1fr; } }
    @media (max-width:768px){
      .hero h1{ font-size:2.1rem; }
      .products-grid{ padding:0 1rem; }
      .nav-container{ padding:0 1rem; }
    }
  </style>
</head>

<body>
  <header class="header">
    <nav class="nav-container">
      <a class="logo" onclick="showShop()">‚òï Yordi Coffee</a>

      <ul class="nav-menu">
        <li><a onclick="showShop()">Shop</a></li>
        <li><a onclick="openAdmin()">Admin</a></li>

        <li>
          <div class="pill" onclick="openCart()">
            üõí Cart <span class="cart-count" id="cartCount">0</span>
          </div>
        </li>

        <li>
          <div class="pill" onclick="reloadAll()">
            üîÑ <span>Refresh</span>
          </div>
        </li>
      </ul>
    </nav>
  </header>

  <section class="hero">
    <h1>Fresh Coffee, Delivered</h1>
    <p>Beans ‚Ä¢ Ground ‚Ä¢ Espresso ‚Ä¢ Traditional ‚Ä¢ Accessories</p>
  </section>

  <div class="filter-section" id="shopSection">
    <div class="filter-container">
      <button class="filter-btn active" onclick="filterProducts('all', this)">All</button>
      <button class="filter-btn" onclick="filterProducts('beans', this)">Beans</button>
      <button class="filter-btn" onclick="filterProducts('ground', this)">Ground</button>
      <button class="filter-btn" onclick="filterProducts('espresso', this)">Espresso</button>
      <button class="filter-btn" onclick="filterProducts('traditional', this)">Traditional</button>
      <button class="filter-btn" onclick="filterProducts('accessories', this)">Accessories</button>
    </div>
  </div>

  <div id="loadingProducts" class="loading">Loading coffee...</div>
  <div class="products-grid" id="productsGrid"></div>

  <!-- ADMIN -->
  <div id="adminSection" class="hidden">
    <div class="admin-panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;flex-wrap:wrap;">
        <h2 style="margin-bottom: 0.5rem;">Admin</h2>
        <button class="btn-ghost" onclick="showShop()">Back to Shop</button>
      </div>

      <div style="display:flex;gap:0.75rem;flex-wrap:wrap;margin:0.75rem 0 1rem;">
        <button class="btn-primary" onclick="setAdminKey()">Set Admin Key</button>
        <button class="btn-danger" onclick="clearAdminKey()">Logout Admin</button>
      </div>

      <p style="color:#636e72;margin-bottom:1.25rem;">
        ‚úÖ Uses backend endpoints:
        <b>GET /api/coffee</b>, <b>POST /api/coffee</b>, <b>PUT /api/coffee/:id</b>, <b>DELETE /api/coffee/:id</b>
      </p>

      <h3 style="margin-bottom:1rem;">Add New Coffee Item</h3>

      <form id="productForm">
        <div class="image-upload-area" onclick="document.getElementById('imageInput').click()">
          <p>üì∑ Upload Image (required, max 2MB)</p>
          <input type="file" id="imageInput" accept="image/*" style="display:none;">
          <img id="imagePreview" class="image-preview hidden" alt="Preview">
        </div>

        <div style="margin-top:1rem;">
          <label><b>Item Name</b></label>
          <input id="productName" required placeholder="e.g., Yirgacheffe Beans 1kg">
        </div>

        <div style="margin-top:1rem;">
          <label><b>Description</b></label>
          <textarea id="productDescription" rows="3" placeholder="Taste notes, roast level, size..."></textarea>
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem;">
          <div>
            <label><b>Category</b></label>
            <select id="productCategory" required>
              <option value="beans">Beans</option>
              <option value="ground">Ground</option>
              <option value="espresso">Espresso</option>
              <option value="traditional">Traditional</option>
              <option value="accessories">Accessories</option>
            </select>
          </div>
          <div>
            <label><b>Price (ETB)</b></label>
            <input type="number" id="productPrice" step="0.01" required placeholder="e.g., 1200">
          </div>
        </div>

        <button class="btn-primary" id="addBtn" type="submit" style="width:100%;margin-top:1.2rem;">Add Item</button>
        <p id="adminStatus" style="margin-top:0.75rem;color:#636e72;font-weight:900;"></p>
      </form>

      <h3 style="margin-top:2rem;margin-bottom:1rem;">Manage Coffee</h3>
      <div class="product-list" id="productList"></div>
    </div>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModal" class="modal-backdrop hidden" onclick="if(event.target.id==='editModal') closeEditModal()">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:1rem;">
        <h2>Edit Item</h2>
        <button class="btn-ghost" onclick="closeEditModal()">‚úï</button>
      </div>

      <p class="muted">Update name, category, description, price, and optionally replace image.</p>

      <input id="editId" type="hidden" />

      <label>Name</label>
      <input id="editName" />

      <label style="margin-top:0.75rem;">Description</label>
      <textarea id="editDescription" rows="3"></textarea>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:0.75rem;">
        <div>
          <label>Category</label>
          <select id="editCategory">
            <option value="beans">Beans</option>
            <option value="ground">Ground</option>
            <option value="espresso">Espresso</option>
            <option value="traditional">Traditional</option>
            <option value="accessories">Accessories</option>
          </select>
        </div>
        <div>
          <label>Price (ETB)</label>
          <input id="editPrice" type="number" step="0.01" />
        </div>
      </div>

      <div style="margin-top:0.75rem;">
        <label>Replace Image (optional, max 2MB)</label>
        <input id="editImage" type="file" accept="image/*" />
        <img id="editPreview" class="image-preview hidden" alt="Preview" />
      </div>

      <div class="hr"></div>

      <div class="actions">
        <button class="btn-primary" onclick="saveEditProduct()">Save</button>
        <button class="btn btn-danger" onclick="closeEditModal()">Cancel</button>
      </div>

      <p id="editMsg" style="margin-top:0.75rem;color:#e74c3c;font-weight:1000;"></p>
    </div>
  </div>

  <!-- CART DRAWER -->
  <div id="cartDrawer" class="drawer-backdrop hidden" onclick="if(event.target.id==='cartDrawer'){closeCart()}">
    <div class="drawer">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>üõí Cart</h2>
        <button class="btn btn-dark" style="width:auto;padding:0.5rem 0.75rem;" onclick="closeCart()">‚úï</button>
      </div>

      <div id="cartItems"></div>

      <div class="hr"></div>
      <div style="display:flex;justify-content:space-between;font-weight:1000;">
        <span>Subtotal</span>
        <span id="cartSubtotal">0 ETB</span>
      </div>

      <button class="btn btn-dark" style="width:100%;margin-top:1rem;" onclick="continueShopping()">Continue Shopping</button>
      <button class="btn-primary" style="width:100%;margin-top:0.6rem;" onclick="openCheckout()">Checkout</button>
      <button class="btn btn-dark" style="width:100%;margin-top:0.6rem;" onclick="clearCart()">Clear Cart</button>
    </div>
  </div>

  <!-- CHECKOUT MODAL -->
  <div id="checkoutModal" class="modal-backdrop hidden">
    <div class="modal">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h2>‚úÖ Checkout</h2>
        <button class="btn btn-dark" style="width:auto;padding:0.5rem 0.75rem;border-radius:10px;" onclick="closeCheckout()">‚úï</button>
      </div>
      <p class="muted">Fill your details and place your order.</p>

      <div class="row">
        <div>
          <label>Full Name</label>
          <input id="ckFullName" placeholder="Full name">
        </div>
        <div>
          <label>Phone</label>
          <input id="ckPhone" placeholder="+251...">
        </div>
      </div>

      <div class="row" style="margin-top:0.75rem;">
        <div>
          <label>City</label>
          <input id="ckCity" placeholder="Addis Ababa">
        </div>
        <div>
          <label>Total</label>
          <input id="ckTotal" disabled>
        </div>
      </div>

      <div style="margin-top:0.75rem;">
        <label>Address</label>
        <input id="ckAddress" placeholder="Street, building, etc...">
      </div>

      <div style="margin-top:0.75rem;">
        <label>Payment Method</label>
        <select id="ckPaymentMethod">
          <option value="cash">Cash on Delivery</option>
          <option value="telebirr">Telebirr</option>
        </select>
      </div>

      <div class="actions" style="margin-top:1rem;">
        <button class="btn-primary" onclick="placeOrder()">Place Order</button>
        <button class="btn btn-dark" style="width:auto;padding:0.85rem 1rem;" onclick="closeCheckout()">Cancel</button>
      </div>

      <p id="checkoutMsg" style="margin-top:0.75rem;color:#e74c3c;font-weight:1000;"></p>
    </div>
  </div>

  <footer class="footer">
    <div class="footer-inner">
      <div>
        <h3>‚òï Yordi Coffee</h3>
        <p>Fresh coffee products ‚Äî beans, ground coffee, espresso & accessories.</p>
      </div>

      <div>
        <h3>Backend</h3>
        <p>API Base: <span id="apiLabel" style="font-weight:1000;"></span></p>
        <p>Health: <span id="healthLabel" style="font-weight:1000;"></span></p>
      </div>

      <div>
        <h3>Hours</h3>
        <p>Mon‚ÄìSat: 8:00 AM ‚Äì 8:00 PM</p>
        <p>Sunday: Closed</p>
      </div>
    </div>

    <div class="footer-bottom">
      ¬© <span id="yy"></span> Yordi Coffee. All rights reserved.
    </div>
  </footer>

<script>
  // ‚úÖ Set your deployed backend URL
  const BACKEND_URL = "https://coffee-1-5gfb.onrender.com";

  const API_BASE =
    (location.hostname === "localhost" || location.hostname === "127.0.0.1")
      ? "http://localhost:3000"
      : BACKEND_URL;

  console.log("API_BASE:", API_BASE);

  // ---- state ----
  let products = [];
  let currentFilter = "all";

  let cart = JSON.parse(localStorage.getItem("YORDI_CART") || "[]");
  const saveCart = () => { localStorage.setItem("YORDI_CART", JSON.stringify(cart)); updateCartCount(); };

  const ADMIN_KEY_STORAGE = "YORDI_ADMIN_KEY";
  const getAdminKey = () => localStorage.getItem(ADMIN_KEY_STORAGE) || "";

  // ---- utils ----
  function escapeHtml(str){
    return String(str ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function formatMoney(n){ return (Number(n)||0).toFixed(0); }

  async function readJsonSafe(res){
    const text = await res.text();
    try { return { text, json: JSON.parse(text) }; }
    catch { return { text, json: null }; }
  }

  function normalizeProduct(p){
    // backend should return {id, name, ...}. but if it returns _id, handle it too.
    const id = p.id || p._id;
    return { ...p, id };
  }

  // ---- nav ----
  function showShop(){
    document.getElementById("adminSection").classList.add("hidden");
    document.getElementById("shopSection").scrollIntoView({ behavior:"smooth" });
  }
  function openAdmin(){
    document.getElementById("adminSection").classList.remove("hidden");
    document.getElementById("adminSection").scrollIntoView({ behavior:"smooth" });
    renderProductList();
  }

  // ---- status ----
  function setAdminStatus(msg, isError=false){
    const el = document.getElementById("adminStatus");
    el.textContent = msg || "";
    el.style.color = isError ? "#e74c3c" : "#636e72";
  }

  // ---- health ----
  async function checkHealth(){
    const label = document.getElementById("healthLabel");
    try{
      const res = await fetch(API_BASE + "/api/health", { cache:"no-store" });
      const { json } = await readJsonSafe(res);
      if(res.ok && json && json.ok){
        label.textContent = "‚úÖ OK";
        label.style.color = "#b6ffb6";
      } else {
        label.textContent = "‚ö†Ô∏è Not OK";
        label.style.color = "#ffd6d6";
      }
    }catch(e){
      label.textContent = "‚ùå Backend not reachable";
      label.style.color = "#ffd6d6";
    }
  }

  // ---- products ----
  async function loadProducts(){
    const loading = document.getElementById("loadingProducts");
    const url = API_BASE + "/api/coffee";

    loading.classList.remove("hidden");
    loading.innerHTML = "Loading coffee...";

    try {
      const res = await fetch(url, { cache: "no-store" });
      const { text, json } = await readJsonSafe(res);

      if(!res.ok){
        throw new Error(`Backend ${res.status}: ${json?.details || json?.error || text || "Unknown error"}`);
      }

      products = (Array.isArray(json) ? json : []).map(normalizeProduct);
      loading.classList.add("hidden");
      renderProducts();
      renderProductList();
    } catch (err) {
      console.error(err);
      loading.innerHTML = `
        <p style="color:#e74c3c;font-weight:900;">Failed to load coffee from backend.</p>
        <p style="color:#636e72;margin-top:0.5rem;">
          API_BASE: <b>${escapeHtml(API_BASE)}</b><br/>
          URL: <b>${escapeHtml(url)}</b><br/>
          Error: <b>${escapeHtml(err.message || String(err))}</b>
        </p>
        <div style="margin-top:0.75rem;">
          <button class="btn-primary" onclick="loadProducts()">Retry</button>
        </div>
      `;
    }
  }

  function filterProducts(category, btnEl){
    currentFilter = category;
    document.querySelectorAll(".filter-btn").forEach(btn => btn.classList.remove("active"));
    if (btnEl) btnEl.classList.add("active");
    renderProducts();
  }

  function renderProducts(){
    const grid = document.getElementById("productsGrid");
    const filtered = (currentFilter === "all")
      ? products
      : products.filter(p => String(p.category || "") === String(currentFilter));

    if (!filtered.length) {
      grid.innerHTML = `<div style="padding:1rem;color:#636e72;">No items found.</div>`;
      return;
    }

    grid.innerHTML = filtered.map(p => `
      <div class="product-card">
        <div class="product-image">
          ${p.image ? `<img src="${p.image}" alt="${escapeHtml(p.name || 'Coffee')}" onerror="this.style.display='none'"/>` : ``}
        </div>
        <div class="product-details">
          <div class="product-category">${escapeHtml(p.category || '')}</div>
          <div class="product-name">${escapeHtml(p.name || '')}</div>
          ${p.description ? `<p style="font-size:0.95rem;color:#636e72;margin:0.4rem 0;">${escapeHtml(p.description)}</p>` : ""}
          <div class="product-price">${formatMoney(p.price)} ETB</div>
          <button class="btn btn-dark" onclick="addToCart('${String(p.id).replaceAll("'","")}')">Add to Cart</button>
        </div>
      </div>
    `).join("");
  }

  // ---- cart ----
  function updateCartCount(){
    const count = cart.reduce((s, it) => s + (Number(it.qty)||1), 0);
    document.getElementById("cartCount").textContent = count;
  }

  function cartSubtotal(){
    return cart.reduce((s, it) => s + (Number(it.price)||0) * (Number(it.qty)||1), 0);
  }

  function addToCart(productId){
    const p = products.find(x => String(x.id) === String(productId));
    if(!p) return alert("Item not found");

    const existing = cart.find(x => String(x.productId) === String(productId));
    if(existing){
      existing.qty = (Number(existing.qty)||1) + 1;
    }else{
      cart.push({
        productId: p.id,
        name: p.name,
        price: Number(p.price)||0,
        qty: 1,
        image: p.image || ""
      });
    }
    saveCart();
    openCart();
  }

  function removeFromCart(productId){
    cart = cart.filter(x => String(x.productId) !== String(productId));
    saveCart();
    renderCart();
  }

  function changeQty(productId, delta){
    const it = cart.find(x => String(x.productId) === String(productId));
    if(!it) return;
    it.qty = Math.max(1, (Number(it.qty)||1) + delta);
    saveCart();
    renderCart();
  }

  function clearCart(){
    if(!confirm("Clear cart?")) return;
    cart = [];
    saveCart();
    renderCart();
  }

  function openCart(){
    document.getElementById("cartDrawer").classList.remove("hidden");
    renderCart();
  }
  function closeCart(){ document.getElementById("cartDrawer").classList.add("hidden"); }
  function continueShopping(){ closeCart(); showShop(); }

  function renderCart(){
    const box = document.getElementById("cartItems");
    if(cart.length === 0){
      box.innerHTML = `<div style="padding:1rem;color:#636e72;border:1px solid #eee;border-radius:14px;margin-top:1rem;">Your cart is empty.</div>`;
      document.getElementById("cartSubtotal").textContent = "0 ETB";
      return;
    }

    box.innerHTML = cart.map(it => `
      <div class="cart-item">
        <div class="cart-thumb">${it.image ? `<img src="${it.image}" onerror="this.style.display='none'">` : ""}</div>
        <div style="flex:1;">
          <div style="font-weight:1000;">${escapeHtml(it.name || "")}</div>
          <div style="color:#e74c3c;font-weight:1000;margin-top:0.2rem;">${formatMoney(it.price)} ETB</div>
          <div class="qty">
            <button onclick="changeQty('${String(it.productId).replaceAll("'","")}', -1)">-</button>
            <span>${Number(it.qty)||1}</span>
            <button onclick="changeQty('${String(it.productId).replaceAll("'","")}', 1)">+</button>
          </div>
        </div>
        <div class="remove-x" title="Remove" onclick="removeFromCart('${String(it.productId).replaceAll("'","")}')">‚úï</div>
      </div>
    `).join("");

    document.getElementById("cartSubtotal").textContent = `${formatMoney(cartSubtotal())} ETB`;
  }

  // ---- checkout ----
  function openCheckout(){
    if(cart.length === 0) return alert("Cart is empty");
    document.getElementById("checkoutMsg").textContent = "";
    document.getElementById("ckTotal").value = formatMoney(cartSubtotal()) + " ETB";
    document.getElementById("checkoutModal").classList.remove("hidden");
  }
  function closeCheckout(){ document.getElementById("checkoutModal").classList.add("hidden"); }

  async function placeOrder(){
    const msgEl = document.getElementById("checkoutMsg");
    msgEl.textContent = "";

    const fullName = document.getElementById("ckFullName").value.trim();
    const phone = document.getElementById("ckPhone").value.trim();
    const city = document.getElementById("ckCity").value.trim();
    const address = document.getElementById("ckAddress").value.trim();
    const paymentMethod = document.getElementById("ckPaymentMethod").value;

    if(!fullName) return msgEl.textContent = "Full name is required";
    if(!phone) return msgEl.textContent = "Phone is required";
    if(!address) return msgEl.textContent = "Address is required";

    const payload = {
      customer: { fullName, phone, city, address },
      payment: { method: paymentMethod },
      items: cart.map(it => ({
        productId: it.productId,
        name: it.name,
        price: it.price,
        qty: it.qty,
        image: it.image || ""
      }))
    };

    try{
      const res = await fetch(API_BASE + "/api/orders", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(json?.error || json?.details || text || "Order failed");

      alert("‚úÖ Order placed! Order ID: " + (json?.orderId || json?.order?.orderId || ""));
      closeCheckout();
      closeCart();
      cart = [];
      saveCart();
    }catch(e){
      msgEl.textContent = e.message;
    }
  }

  // ---- admin helpers ----
  function setAdminKey(){
    const k = prompt("Enter ADMIN_API_KEY:");
    if(!k) return;
    localStorage.setItem(ADMIN_KEY_STORAGE, k.trim());
    alert("Admin key saved on this browser.");
  }
  function clearAdminKey(){
    localStorage.removeItem(ADMIN_KEY_STORAGE);
    alert("Admin logged out (key removed).");
  }

  function requireAdminKey(){
    const k = getAdminKey();
    if(!k){
      alert("Admin key not set. Click 'Set Admin Key' first.");
      return null;
    }
    return k;
  }

  // ---- admin list ----
  function renderProductList(){
    const list = document.getElementById("productList");
    if (!products.length) {
      list.innerHTML = '<p style="color:#636e72;padding:1rem;">No items yet.</p>';
      return;
    }

    list.innerHTML = products.map(p => `
      <div class="product-item">
        <div class="product-item-image">
          ${p.image ? `<img src="${p.image}" alt="${escapeHtml(p.name || '')}" onerror="this.style.display='none'">` : ``}
        </div>
        <div class="product-item-details">
          <h3>${escapeHtml(p.name || '')}</h3>
          <p style="color:#636e72;"><b>Category:</b> ${escapeHtml(p.category || '')}</p>
          <p style="color:#636e72;"><b>Price:</b> ${formatMoney(p.price)} ETB</p>
        </div>
        <div class="product-actions">
          <button class="btn-ghost" onclick="openEditProduct('${String(p.id).replaceAll("'","")}')">Edit</button>
          <button class="btn-danger" onclick="deleteProduct('${String(p.id).replaceAll("'","")}')">Delete</button>
        </div>
      </div>
    `).join("");
  }

  // ---- admin add/edit/delete (FormData, matches backend I gave) ----
  async function addProduct(formEl){
    const adminKey = requireAdminKey();
    if(!adminKey) return;

    const file = document.getElementById("imageInput").files[0];
    if (!file) return alert("Please select an image file.");
    if (file.size > 2 * 1024 * 1024) return alert("Image too large. Please use an image under 2MB.");

    const name = document.getElementById("productName").value.trim();
    const description = document.getElementById("productDescription").value.trim();
    const category = document.getElementById("productCategory").value;
    const price = document.getElementById("productPrice").value;

    const fd = new FormData();
    fd.append("image", file);
    fd.append("name", name);
    fd.append("description", description);
    fd.append("category", category);
    fd.append("size", "single"); // simple default; backend expects size
    fd.append("price", price);

    const btn = document.getElementById("addBtn");
    btn.disabled = true;
    btn.textContent = "Uploading...";
    setAdminStatus("Uploading image + saving coffee...");

    try{
      const res = await fetch(API_BASE + "/api/coffee", {
        method: "POST",
        headers: { "x-admin-key": adminKey },
        body: fd
      });

      const { text, json } = await readJsonSafe(res);
      if (!res.ok) throw new Error(json?.error || json?.details || text || "Failed to add item");

      alert("‚úÖ Coffee item added!");
      setAdminStatus("Saved ‚úÖ");

      formEl.reset();
      document.getElementById("imagePreview").classList.add("hidden");

      await loadProducts();
    }catch(e){
      setAdminStatus("Error: " + e.message, true);
      alert("Add error: " + e.message);
    }finally{
      btn.disabled = false;
      btn.textContent = "Add Item";
    }
  }

  function openEditProduct(id){
    const p = products.find(x => String(x.id) === String(id));
    if(!p) return alert("Item not found");

    document.getElementById("editMsg").textContent = "";
    document.getElementById("editId").value = p.id;
    document.getElementById("editName").value = p.name || "";
    document.getElementById("editPrice").value = Number(p.price) || 0;
    document.getElementById("editDescription").value = p.description || "";
    document.getElementById("editCategory").value = p.category || "beans";

    const prev = document.getElementById("editPreview");
    if(p.image){
      prev.src = p.image;
      prev.classList.remove("hidden");
    } else {
      prev.classList.add("hidden");
    }

    document.getElementById("editImage").value = "";
    document.getElementById("editModal").classList.remove("hidden");
  }

  function closeEditModal(){ document.getElementById("editModal").classList.add("hidden"); }

  async function saveEditProduct(){
    const adminKey = requireAdminKey();
    if(!adminKey) return;

    const id = document.getElementById("editId").value;
    const name = document.getElementById("editName").value.trim();
    const price = document.getElementById("editPrice").value;
    const description = document.getElementById("editDescription").value.trim();
    const category = document.getElementById("editCategory").value;
    const file = document.getElementById("editImage").files[0];

    const msg = document.getElementById("editMsg");
    msg.textContent = "";

    if(!name) return msg.textContent = "Name is required";
    if(!price) return msg.textContent = "Price is required";
    if(file && file.size > 2 * 1024 * 1024) return msg.textContent = "Image too large (max 2MB)";

    const fd = new FormData();
    fd.append("name", name);
    fd.append("price", price);
    fd.append("description", description);
    fd.append("category", category);
    fd.append("size", "single");
    if(file) fd.append("image", file);

    try{
      const res = await fetch(API_BASE + "/api/coffee/" + encodeURIComponent(id), {
        method: "PUT",
        headers: { "x-admin-key": adminKey },
        body: fd
      });

      const { text, json } = await readJsonSafe(res);
      if(!res.ok) throw new Error(json?.error || json?.details || text || "Update failed");

      alert("‚úÖ Updated!");
      closeEditModal();
      await loadProducts();
    }catch(e){
      msg.textContent = e.message;
    }
  }

  async function deleteProduct(id){
    if (!confirm("Delete this item?")) return;
    const adminKey = requireAdminKey();
    if(!adminKey) return;

    try{
      const res = await fetch(API_BASE + "/api/coffee/" + encodeURIComponent(id), {
        method: "DELETE",
        headers: { "x-admin-key": adminKey }
      });

      const { text, json } = await readJsonSafe(res);
      if (!res.ok) throw new Error(json?.error || json?.details || text || "Delete failed");

      alert("‚úÖ Deleted!");
      await loadProducts();
    }catch(e){
      alert("Delete error: " + e.message);
    }
  }

  // ---- page ----
  function reloadAll(){
    loadProducts();
    checkHealth();
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("yy").textContent = new Date().getFullYear();
    document.getElementById("apiLabel").textContent = API_BASE;

    document.getElementById("imageInput").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.getElementById("imagePreview");
        img.src = ev.target.result;
        img.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("editImage").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        const img = document.getElementById("editPreview");
        img.src = ev.target.result;
        img.classList.remove("hidden");
      };
      reader.readAsDataURL(file);
    });

    document.getElementById("productForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      await addProduct(e.target);
    });

    updateCartCount();
    checkHealth();
    loadProducts();
  });
</script>

</body>
</html>
